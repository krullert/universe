git:
  depth: false
  clone: false
language: java
jdk: oraclejdk8
install: true

cache:
  directories:
    - $HOME/.m2

before_script:
  - echo 'github.com ssh-rsa $PUBLIC_KEY' >> ~/.ssh/known_hosts
  - git clone "https://github.com/onsense/universe.git" .
  - git fetch --force origin "travis-ci:remotes/origin/travis-ci"
  - git reset --hard "HEAD"
  - git checkout -q -B "travis-ci"
  - git config --global gc.auto 0 || true
  - git config user.name "$COMMIT_AUTHOR_NAME"
  - git config user.email "$COMMIT_AUTHOR_EMAIL"
  - openssl aes-256-cbc -K $encrypted_227cb85660eb_key -iv $encrypted_227cb85660eb_iv -in deploy_key.enc -out ./deploy_key -d
  - ssh-add ./deploy_key
  - git remote set-url origin "https://github.com/onsense/universe.git" || true
  - export COMMIT_MESSAGE=`git log -1 --oneline`

script:
  - mvn clean install -DskipTests=true

deploy:
  provider: script
  script: 'chmod +x ./configure-maven.sh && ./configure-maven.sh && chmod -x ./configure-maven.sh && mvn --settings .mvn/conf/settings.xml --batch-mode --activate-profiles release --fail-at-end org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare -DskipTests=true -DskipITs=true -Darguments="-DskipTests=true -DskipITs=true"'
  skip_cleanup: true
  on:
    all_branches: true